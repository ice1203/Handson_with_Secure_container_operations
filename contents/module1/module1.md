# 座学

## Amazon ECSのベストプラクティスについて

AWSではAmazon ECS（以下、ECS）のベストプラクティスとして以下のドキュメントを提供しています。

https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/bestpracticesguide/intro.html

このベストプラクティスにはECSでシステムを構築するうえでの知っておいたほうがいいことが多く記載されています。
が、いかんせんボリュームが多いので、上記の内容の中から私の観点で重要だと思うことをまとめ、チェックリスト形式にしたものを末尾にまとめています。

## 前提知識

- コンテナの基礎的な知識(Dockerfileを書いたことがあり、dockerコマンドを使ったことがあればOKです)
- ECSの概要（ECSクラスター、ECSサービス、ECSタスクがそれぞれどのように関係してくるのかが分かればOKです）

## 本ハンズオンで実施すること

本ハンズオンはこのECSベストプラクティスになるべく沿いつつ、以下の要素を加えたものになっています。

- CI/CDにはGitHub Actionsを使用
- コンテナセキュリティ関連のベストプラクティスを満たすためにSysdigを使用

ハンズオンは以下の流れで実施します。

1. ECSをまずデプロイ
2. GitHub Actionsを使って、インフラのCI/CD
    1. ビルド時のスキャン
    2. 脆弱性の修正
    3. 再度デプロイ
3. GitHub Actionsを使って、アプリケーションデプロイ
    1. ビルド時のコンテナイメージスキャン
    2. ロールバック
    3. 脆弱性の修正
    4. 再度デプロイ
4. ECRの定期スキャン
5. Sysdigランタイムモニタリングの導入
    1. 脆弱性を検知させる
    2. チェックする
    3. 対処する
6. モニタリングを試す

## ECSベストプラクティス チェックリスト

### コンテナイメージ設計

| チェック欄 | チェック内容                                                                               | チェック対象実行基盤 | 備考 |
| ---------- | ------------------------------------------------------------------------------------------ | -------------------- | ---- |
| □          | コンテナイメージにすべてのアプリケーション依存関係を静的ファイルとして含めているか         | EC2,Fargate          |      |
| □          | プロセスの単位（1プロセス=1コンテナ）に沿ったコンテナ構成になっているか                    | EC2,Fargate          |      |
| □          | アプリケーションが SIGTERM を処理するように設定されているか                                | EC2,Fargate          |      |
| □          | コンテナ化されたアプリケーションのログを stdout と stderr に書き込むように設定されているか | EC2,Fargate          |      |
| □          | コンテナイメージにアプリケーションバージョンタグを使用しているか                           | EC2,Fargate          |      |
| □          | コンテナイメージサイズは最小化されているか                                                 | EC2,Fargate          |      |

### タスク定義関連

| チェック欄 | チェック内容                                                                                                                 | チェック対象実行基盤 | 備考                                                                                                                                                |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------- | -------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| □          | 複数のコンテナが共通のライフサイクルを持ち、一緒に起動・終了する場合は、同一タスク定義内にそれらのコンテナが配置されているか | EC2,Fargate          |                                                                                                                                                     |
| □          | 複数のコンテナがlocalhostポートを介して相互に通信する必要がある場合は、同一タスク定義内にそれらのコンテナが配置されているか  | EC2,Fargate          |                                                                                                                                                     |
| □          | 複数のコンテナがバインドマウント等で同じデータを共有する要件がある場合、同一タスク定義内にそれらのコンテナが配置されているか | EC2,Fargate          |                                                                                                                                                     |
| □          | 上記のような条件に一致しないコンテナ同士が別々のタスク定義となるように設計されているか                                       | EC2,Fargate          |                                                                                                                                                     |
| □          | ECS管理タグとタグ伝播が実装されているか                                                                                      | EC2,Fargate          |                                                                                                                                                     |
| □          | タグにはアプリケーションバージョンがついてるか                                                                               | EC2,Fargate          | コードverとコンテナイメージタグとタスク定義リビジョンが1:1のマッピングとなるようにする                                                              |
| □          | タグに属性をつけてるか                                                                                                       | EC2,Fargate          | 開発、本番環境とかfront,backendとか                                                                                                                 |
| □          | タスク定義に独自のIAMロールつけてるか                                                                                        | EC2,Fargate          | 最小権限の原則に則っているか                                                                                                                        |
| □          | ECSタスクのサイズを適切にしてるか                                                                                            | EC2,Fargate          | cpu、メモリのハードリミット（タスクやコンテナが使用できる最大リソース）、ソフトリミット（タスクやコンテナに必要な最小リソース）を適切に設定してるか |
| □          | タスクサイズを適切に決めるために負荷テストを実施しているか                                                                   | EC2,Fargate          | 負荷テストツール例： https://aws.amazon.com/jp/solutions/implementations/distributed-load-testing-on-aws/                                           |
- 参考
    - https://d1.awsstatic.com/webinars/jp/pdf/services/20191127_AWS-BlackBelt_Container_Insights.pdf
    - https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/cloudwatch-container-insights.html

### AutoScaling関連

| チェック欄 | チェック内容                                                         | チェック対象実行基盤 | 備考                                                                                                                                                                                                       |
| ---------- | -------------------------------------------------------------------- | -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| □          | AutoScalingのスケーリングメトリクスに最適なものを選択しているか      | EC2,Fargate          | 負荷テストを行いシステム特性に沿ったメトリクスを選択する。例えばステートレスなアプリケーションではCPU、ApacheやGunicornなどのワーカーベースのアプリケーションではActiveConnectionCountのメトリクスを選択等 |
| □          | AutoScalingのしきい値は余裕を持った設定になっているか                | EC2,Fargate          | メトリクスの収集を経て、メトリクスがしきい値をx回超えたら初めてスケールするので、スケールするまでは時間がかかる。そのため、スケーリングターゲットは余裕を持った値にする                                    |
| □          | ECSサービス設定でタスクを複数のAZに配置する設定になっているか        | EC2,Fargate          | AZが多いほど障害時のパフォーマンスへの影響は小さくなる（2AZの場合は50%のタスクが停止するが3AZなら33%のタスク停止）                                                                                         |
| □          | ECSタスクとECRは同一リージョンとなっているか                         | EC2,Fargate          | 異なるリージョンだとコンテナイメージのpull速度がネックとなり、スケーリング速度に影響                                                                                                                       |
| □          | スケーリング速度を重視する場合、ステップスケーリングを使用しているか | EC2,Fargate          | ターゲットスケーリングよりもカスタマイズ可能な部分が多いので、少ない時間でスケーリング判断ができる                                                                                                         |

### クラスタ関連

| チェック欄 | チェック内容                                     | チェック対象実行基盤 | 備考                                                                                                                     |
| ---------- | ------------------------------------------------ | -------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| □          | クラスタにキャパシティプロバイダを設定しているか | EC2,Fargate          | 特にec2のとき。Fargateの場合Fargate Spotを使わないなら考慮不要                                                           |
| □          | Spotインスタンス,FargateSpotを活用しているか     | EC2,Fargate          | Spotが許容される要件のとき                                                                                               |
| □          | クラスタが適切に分離されているか                 | EC2,Fargate          | リソース分離、異なるデプロイパイプライン、異なるスケーリング要件、異なるセキュリティ要件、異なるNW要件の場合に分離を行う |
| □          | コンテナに適したOSを使用しているか               | EC2                  | AmazonLinux,Ubuntu,bottleRocket                                                                                          |

### ネットワーク

| チェック欄 | チェック内容                                                                                                     | チェック対象実行基盤 | 備考                                                                                                                                                                      |
| ---------- | ---------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| □          | インターネットからのインバウンド通信を受け入れる必要がある箇所についてはイングレスコントローラーを使用しているか | EC2,Fargate          | イングレスコントローラーとは一般的には外部（インターネットや社内ネットワーク）からのトラフィックを管理するものという定義。主な選択肢としてはALB,NLB,API Gateway(HTTP API) |
| □          | イングレスコントローラーでトラフィックを制御するために適切なルールを使っているか                                 | EC2,Fargate          | ALBリスナールール等のこと                                                                                                                                                 |
| □          | イングレスコントローラーへの通信経路をTLS暗号化しているか                                                        | EC2,Fargate          |                                                                                                                                                                           |
| □          | VPC内でのecsタスク間の通信については、インターネット経由にせず、適切なサービス間通信方式を選択してるか           | EC2,Fargate          |                                                                                                                                                                           |
- 参考
    - https://tech.nri-net.com/entry/ecs_service_to_service_communication
    - https://dev.classmethod.jp/articles/ecs-service-connet/

### ストレージ

| チェック欄 | チェック内容                                                                                                                     | チェック対象実行基盤 | 備考                                             |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------ |
| □          | 対象アプリケーションに適したストレージを選択してるか                                                                             | EC2,Fargate          | ストレージの選択肢としてはEFS,EBS,DockerVolume等 |
| □          | EFSのマウントターゲットが各AZに作成されているか                                                                                  | EC2,Fargate          | EFSを使用している場合                            |
| □          | EFSマウントする際にIAM認証を使うように設定しているか                                                                             | EC2,Fargate          | EFSを使用している場合                            |
| □          | EFSでアクセスポイントを使っているか                                                                                              | EC2,Fargate          | EFSを使用している場合                            |
| □          | EFSでセキュリティグループがECSタスクからの2049ポートのみ許可するようになっているか                                               | EC2,Fargate          | EFSを使用している場合                            |
| □          | 起動したECSタスクがタスク配置の制約パラメータを使って、特定のインスタンス（データEBSがある）でのみ起動されるようになっているか？ | EC2                  | EBSを使用している場合                            |

### 開発効率化/運用自動化

| チェック欄 | チェック内容                                        | チェック対象実行基盤 | 備考 |
| ---------- | --------------------------------------------------- | -------------------- | ---- |
| □          | インフラのコード化してるか                          | EC2,Fargate          |      |
| □          | インフラ/アプリのコードがバージョン管理されているか | EC2,Fargate          |      |
| □          | ロールバック手順を用意してるか                      | EC2,Fargate          |      |
| □          | インフラのCI/CDをしてるか                           | EC2,Fargate          |      |
| □          | アプリケーションのCI/CDをしてるか                   | EC2,Fargate          |      |

### セキュリティ

| チェック欄 | チェック内容                                                                                                                       | チェック対象実行基盤 | 備考                                                               |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------------------------ |
| □          | 各IAMプリンシパルに付与する権限は最小権限の原則に則っているか                                                                      | EC2,Fargate          |                                                                    |
| □          | 主にECSの管理を行うIAMプリンシパルについて（ex: Github Actionsで使用するIAMロール）クラスターの単位を境界として権限を付与しているか | EC2,Fargate          |                                                                    |
| □          | ユーザが直接ECSに対してデプロイさせないようにIAM権限を制限しパイプラインによってのみデプロイできるようになっているか               | EC2,Fargate          |                                                                    |
| □          | 通信の暗号化をしているか                                                                                                           | EC2,Fargate          | EndtoEndで暗号化するのが理想だがどこまでやるかは要件に応じて決める |
| □          | ネットワークモードにawsvpcを使いタスク単位でセキュリティグループを割り当てているか                                                 | EC2                  | Fargateではawsvpcしか選択不可                                      |
| □          | ネットワークの厳密な分離が必要な場合、別VPCにECSクラスターを作成しているか                                                         | EC2,Fargate          |                                                                    |
| □          | VPC Flow Logsを取得しているか                                                                                                      | EC2,Fargate          |                                                                    |
| □          | センシティブなデータ（APIキー、パスワード等）はシークレットマネージャやパラメータストアを使ってコンテナにデータわたしてるか        | EC2,Fargate          |                                                                    |
| □          | ランタイムモニタリングを入れてるか                                                                                                 | EC2,Fargate          |                                                                    |
| □          | コンテナイメージのビルド時のスキャンをしてるか                                                                                     | EC2,Fargate          |                                                                    |
| □          | 定期的なスキャンをしてるか                                                                                                         | EC2,Fargate          |                                                                    |

### オブザーバビリティ

| チェック欄 | チェック内容                                                                           | チェック対象実行基盤 | 備考 |
| ---------- | -------------------------------------------------------------------------------------- | -------------------- | ---- |
| □          | （前提として）モニタリングの目的、対象、通知先などを定義したモニタリング計画があるか？ | EC2,Fargate          |      |
| □          | 個々のコンテナレベルまで詳細にみれるロギング、メトリクス、トレース機能があるか？       | EC2,Fargate          |      |
| □          | アプリ、インフラ両方の観点でメトリクス収集、フィルタリングする機能があるか             | EC2,Fargate          |      |
| □          | リージョン、アカウントまたぎの場合も適切にロギング、メトリクス、トレースがとれるか？   | EC2,Fargate          |      |

[Next: ECSのデプロイ](../module2/module2.md)
